#summary Connecting Galileo to a Camera - mmjuban
#labels Featured

= What We Know =

   # The target camera to be used is the existing department's Nikon Coolpix P300
   # This camera uses PTP protocol and does not mount using the USB Mass Storage protocol (like Flash thumb drives)
   # An open source library and commandline, libgphoto2 and gphoto2 respectively, are available and has been used on RasberryPi
   *     http://www.gphoto.org/
   # We can access the microSD card as it is mounted in /media/mmcblk0p1
   *     I copied a few jpg files and one png file to the microSD card using the SD converter directly connected to my laptop but have not checked the files are actually there in the Linux commandline

= What We Don't Know =

   # How to enable gPhoto2 in the Yocto Linux image to establish communications with cameras using PTP

= What I've accomplished so far =

   == Creating the Linux image ==
        Downloaded LINUX_IMAGE_FOR_SD_Intel_Galileo_v0.7.5.7z from: https://downloadcenter.intel.com/Detail_Desc.aspx?agr=Y&DwnldID=23171
        Extracted image to 4GB microSD card
        Didn't work!!!
        followed instructions to create boot partition (see Image 1 on sidebar)
        Then it booted up from the microSD card (take a while) and the Blink sketch was retained after reboot!
   == Problems with unable to upload Sketches ==
        There seems to be a bug with Arduino 1.5.3 and the Yocto 0.7.5 image that causes  it to hang. Found the procedure to recover from here: https://communities.intel.com/thread/48975?start=0&tstart=0 
             IDE hangs on:
                echo "Deleting existing sketch on target" $fixed_path/lsz.exe --escape -c "mv -f /sketch/sketch.elf /sketch/sketch.elf.old" <> $tty_port_id 1>&0
            Procedure to recover:
                Exiting the Arduino IDE
                Killing the lsz.exe process
                Rebooting the Galileo (unplug power)
   == Establishing communications with the Linux partition ==
        use Poor Man's Telnet sketch from here: https://communities.intel.com/thread/48654?start=0&tstart=0
            upload sketch
            open up Serial Monitor
            set line terminator to Carriage Return
            set baud rate to 115200
            tested by using the following commands:
                uname -a 
                ls
                mkdir Melvin
                ls
                rmdir Melvin
                ls
            This method is limited though: "The script always spawns a new child prcess. The child process executes the cd command and then dies." but at least I know now that the Linux image is alive and working
        To get full communications we'll need to establish connection via Ethernet or serial cable... https://communities.intel.com/message/212631#212631
            I don't have a serial cable, USB-to-serial converter or a computer that has a serial port so we'll shelve that option for now. We'll go for the Ethernet connection
            I can't get StartEthernet.ino to work for me both in the office or home network to establish an SSH connection.
            Telnet worked: https://communities.intel.com/message/208564#208564 Yay!
                Establishes a telnet connection using putty
                Tested working in both direct laptop connection and home network connection modes (on my home laptop)
                Make sure to know the subnet and available ipaddress to use
                    I tried just letting the network assign dynamic IP using DHCP but it didn't work
                    Setting static ip worked on my home network:
                        system("ifconfig eth0 192.168.11.88 netmask 255.255.255.0 up");
                Select telnet in putty and type in the ipaddress and I was able to get full access to the Linux commandline interface!
               === Now to get this to work in the office using the work laptop... the saga continues ===
            Using this sketch worked for me: accessing via SSH in Unbuntu 12.04
{{{
#include <SPI.h>
#include <Ethernet.h>
// Netwoking ver 2. Nguyen Hoang Hai.
// network configuration. dns server, gateway and subnet are optional.

byte mac[] = { 0x98, 0x4F, 0xEE, 0x00, 0x6D, 0x16 }; // Galileo MAC address
//the IP address for the Galileo: (will be used if there’s no DHCP server on your network)
IPAddress ip(192, 168, 11, 11);
boolean Networking;

// the dns server ip
IPAddress dnServer(192, 168, 11, 1);
// the router's gateway address:
IPAddress gateway(192, 168, 11, 1);
// the subnet:
IPAddress subnet(255, 255, 255, 0);

//the IP address is dependent on your network
int led = 13;

void setup() {
  Serial.begin(9600);

  // initialize the ethernet device
  Ethernet.begin(mac, ip, dnServer, gateway, subnet);
  //print out the IP address
  Serial.print("IP = ");
  Serial.println(Ethernet.localIP());
  pinMode(led, OUTPUT); // setting led for
}

void loop() {
  // blink so that you know your board is work
  digitalWrite(led, HIGH);   // turn the LED on (HIGH is the voltage level)
  delay(200);               // wait for a second
  digitalWrite(led, LOW);    // turn the LED off by making the voltage LOW
  delay(200); 
  // end of blink
  Serial.print("IP = ");
  Serial.println(Ethernet.localIP()); // tell the local IP
}
}}}
   == Establishing connection with the camera though USB ==
        Although my research on the Internet and actually checking the USB descriptors indicate that this camera indeed uses PTP and not the USB Mass Storage protocol I still had to try...
        First was to learn to mount a Flash drive to establish a frame of reference
            Using a USB-to-go cable I bought for my Android phone, I connected my 32GB Sandisk Cruzer flash thumb drive and the kernel recognized it as a USB Mass Storage device in /dev/sda1 by checking the kernel log via the dmesg Linux command (or lsusb)
            I was able to mount it to a directory I created called /flashdrive using mount /dev/sda1 /flashdrive https://www.suse.com/communities/conversations/manually-mounting-a-usb-flash-drive-in-linux/
        I tried plugging-in the Nikon Coolpix P300 but, as expected, it was not recognized as a USB Mass Storage Device. I tried with 3 other cameras, 2 Canon and 1 Olympus, lying around in the house hoping one of them might work. Unfortunately, all of them use PTP
        I tried running gphoto2 but the command is not found. Obviously this was not installed in the stock Yocto Linux image 0.7.5
        === Need to ask for help if someone has an image with gphoto2 installed or learn to do it myself!!! ===
== Compiling gphoto2 into the linux image ==
 # i replaced the 0.7.5 linux image with one that has compiling capability https://communities.intel.com/message/228273
 # downloaded the source code for libgphoto2 and gphoto2
 # copied the source code into the image
 # tried to `./configure` and got this error message:
{{{
root@clanton:/media/mmcblk0p1/libgphoto2-2.5.4# ./configure
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... configure: error: newly created file is older than distributed files!
Check your system clock
}}}
 # seems like the system clock is not set correctly... after some quick research this is expected since we dont have a battery installed to retain a "real" clock.
 # tried running `ntpupdate pool.ntp.org` but got this:
{{{
root@clanton:/media/mmcblk0p1/libgphoto2-2.5.4# ntpdate pool.ntp.org
Error resolving pool.ntp.org: Name or service not known (-2)
11 Mar 23:09:54 ntpdate[1679]: Can't find host pool.ntp.org: Name or service not known (-2)
11 Mar 23:09:54 ntpdate[1679]: no servers can be used, exiting
}}}
 # set the date using `date -s "10 APR 2014 18:46:00"`
 # tried `./configure` again and got to here:
{{{
checking ltdl.h usability... no
checking ltdl.h presence... no
checking for ltdl.h... no
checking that we can compile and link with libltdl... no
configure: error: cannot compile and link against libltdl
libgphoto2 requires libltdl (the libtool dl* library),
but cannot compile and link against it.
}}}
 # downloaded `libtools` from http://ossm.utm.my/gnu/libtool/libtool-2.4.2.tar.gz
 # copied to SD card
 # run `./configure` no errors!
 # run `make`
 # run `make install`
 # now back to libgphoto2
 # run `date -s "10 APR 2014 18:46:00"`
 # run `./configure`, `make`, and `make install`
   errors at the end of make install:
{{{
make[1]: Entering directory `/media/mmcblk0p1/libgphoto2-2.5.4'
make[2]: Entering directory `/media/mmcblk0p1/libgphoto2-2.5.4'
 /bin/mkdir -p '/usr/local/bin'
 /usr/bin/install -c gphoto2-config '/usr/local/bin'
rm -f /usr/local/include/gphoto2/gphoto2
rm: cannot remove '/usr/local/include/gphoto2/gphoto2': Is a directory
make[2]: *** [install-data-local] Error 1
make[2]: Leaving directory `/media/mmcblk0p1/libgphoto2-2.5.4'
make[1]: *** [install-am] Error 2
make[1]: Leaving directory `/media/mmcblk0p1/libgphoto2-2.5.4'
make: *** [install-recursive] Error 1
}}}
 # now onto `gphoto2`
 # run `./configure`, `make`, and `make install`
   error during ./configure
{{{
checking popt.h usability... no
checking popt.h presence... no
checking for popt.h... no
checking popt.h usability... no
checking popt.h presence... no
checking for popt.h... no
configure: error: 
* Cannot autodetect popt.h
*
* Set POPT_CFLAGS and POPT_LIBS correctly.
}}}
    download and install popt from http://www.linuxfromscratch.org/blfs/view/svn/general/popt.html
    ./configure --prefix=/usr --disable-static >log_configure.txt
    make >log_make.txt
    make install >log_makeinstall.txt
 # errors at make and make install
 # trying popt-1.14 pre-compiled for Quark from Nicolas
 # run `./configure`, and `make install` (no need to run `make`)
 # some warnings due to date set incorrect
 # set the date using `date -s "15 APR 2014 18:46:00"`
 # re-run `make install`, no more warnings!
 # === waiting... ===
 # rerun `./configure` for gphoto2
 # still problem autodetecting popt
{{{
root@clanton:/media/mmcblk0p1/gphoto2-2.5.4# ./configure >log_configure2.txt./configure: line 14460: test: : integer expression expected
configure: error: 
* Cannot autodetect library directory containing popt
*
* Set POPT_CFLAGS and POPT_LIBS correctly.
}}}
 # run:
{{{
POPT_CFLAGS=-I/usr/local/include
POPT_LIBS="-L/usr/local/lib -lpopt"
}}}
 # run `./configure --prefix=/usr/local`
 # error
{{{
root@clanton:/media/mmcblk0p1/gphoto2-2.5.4# ./configure POPT_CFLAGS=-I/usr/local/include POPT_LIBS="-L/usr/local/lib -lpopt" >log_configure5.txt
./configure: line 14460: test: : integer expression expected
config.status: WARNING:  'po/Makefile.in.in' seems to ignore the --datarootdir setting
root@clanton:/media/mmcblk0p1/gphoto2-2.5.4# make >log_make.txt
In file included from actions.c:39:0:
actions.h:24:36: fatal error: gphoto2/gphoto2-camera.h: No such file or directory
}}}
 # upon checking, `gphoto2/gphoto2-camera.h` is actually inside libgphoto2, not gphoto. how do i point the compile to grab gphoto2-camera.h from the libphoto directory while I am in the gphoto directory performing the `make`?
{{{
root@clanton:/media/mmcblk0p1/libgphoto2-2.5.4/gphoto2# ls
gphoto2-abilities-list.h  gphoto2-filesys.h  gphoto2-setting.h
gphoto2-camera.h	  gphoto2-library.h  gphoto2-version.h
gphoto2-context.h	  gphoto2-list.h     gphoto2-widget.h
gphoto2-file.h		  gphoto2-result.h   gphoto2.h

root@clanton:/media/mmcblk0p1# ls
PaxHeaders.1163  core-image-minimal-initramfs-clanton.cpio.gz  libtool-2.4.2
README.txt	 gphoto2-2.5.4				       melvin
boot		 image-full-clanton.ext3		       popt-1.14
bzImage		 libgphoto2-2.5.4			       popt-1.16-fail
}}}
 # === I STOPPED HERE, ARRRGHHH!!! ===
 # run `make` & `make install`
 # test gphoto2 by running `gphoto2 -v`
 # run `gphoto2 --auto-detect`

HELP:
Hi Melvin,

To have a more stable linux, my advice would be to compile your packages for the full Clanton image (as described here: http://www.malinov.com/Home/sergey-s-blog/intelgalileo-buildinglinuximage and also available on Intel Software Academic program http://intel-software-academic-program.com/pages/courses#diy).

I’m sending you compiled-for-Quark and ready-to-install archives of popt.

So, the procedure I suggest you to install it is:
-	Use the full clanton image and copy archives on the SD card too
-	Connect with SSH over Ethernet (Wifi is also available with some adaptors)
-	Extract files from archives (in /media/mmcblk0p1/)
-	(./configure : not sure you need to run this one, I usually do it, even if it takes some time…)
-	(no make, already done it)
-	make install

It takes some time and works on Galileo (I mean installation sounds to be successful, you should test with your camera).
I also did it with libgphoto2 and it ends fine (but the archive is too heavy to be sent).

If you want to compile this lib, you need, either the cross compile toolchain (see malinov.com) or to mount the full clanton image onto  your Ubuntu file system.
Sudo mount –o loop –t ext3 image-clanton-full.ext3 /mnt
Copy your source files to /home/root, then
Sudo Chroot /mnt
Then, configure, make, make install.

Hope this help,
Nicolas

PS: Extra stuff

I’ve created a Debian (i386)  image based on this tutorial http://wiki.ros.org/IntelGalileo/Debian (take a look only if you want to keep on this track, they explain how to install any packages you want while generating the image).
However, we figured out that some packages (eg ffmpeg) don’t work, as Quark instructions set and i386 instructions set are different.
An ‘illegal instruction’ issue would appear randomly when starting or running a program.
Moreover, it has not node.js which is not convenient for you. The image is available here: http://intel-software-academic-program.com/pages/courses#diy